#!/bin/bash
# vim:set et sw=2:

if [ $# -gt 0 ]; then
  command="$1"
  shift
fi

case "$command" in
  create)
    operation="$1"
    shift
    case "$operation" in 
      host-crt)
        echo -e 'Creating key...'
        host=$(harunou hostname)
        openssl genpkey -algorithm RSA -aes-128-cbc -out "$host".key 
        echo -e '\nCreating crt...'
        openssl req -x509 -key "$host".key -out "$host".crt -subj "/CN=$host/O=$host/emailAddress=$USER"
        ;;

      domain-crt)
        domain=$1
        cakey=$2
        cacrt=$3
        host=$(harunou hostname)
        openssl genpkey -algorithm RSA -out "$domain".key
        openssl req -new -key "$domain".key -out "$domain".csr -subj "/CN=$domain/O=$host/emailAddress=$USER"
        openssl x509 -req -in "$domain".csr -days 365 -out "$domain".crt \
                -CA $cacrt -CAkey $cakey -CAcreateserial \
                -extfile <(cat <<END
                basicConstraints = CA:FALSE
                subjectKeyIdentifier = hash
                authorityKeyIdentifier = keyid,issuer
                subjectAltName = DNS:$domain
END
)
        ;;
    esac
    ;;

  check)
    operation="$1"
    shift
    case "$operation" in 
      key)
        openssl rsa -in $1 -check
        ;;

      csr)
        openssl req -text -noout -verify -in $1
        ;;

      crt)
        openssl x509 -in $1 -text -noout
        ;;
    esac
    ;;

  trust)
    crt=$1
    harunou-ssl untrust $crt
    sudo trust anchor $crt
    ;;

  untrust)
    crt=$1
    sudo trust anchor --remove $crt || true
    ;;

  '') 
    echo "Usage: `basename "$0"` <command> [options]" 
    ;;

  *) 
    echo "`basename "$0"` $command: unknown command." >&2; exit 1 
    ;;
esac
