#!/bin/sh
# vim:set et sw=2:


as_root(){
  exec sudo "$@"
}

setup_basics() {
  if [ ! -f "$HOME/. harunou" -o -r "$HOME/. harunou" ]; then
    [ -f "$HOME/. harunou" ] || basics=1
    touch "$HOME/. harunou"
    chmod 0000 "$HOME/. harunou"
  fi
  [ -z "$basics" ] || echo "Initializing basic configuration."
}

setup_fonts() {
  fontsdir="$HOME/.local/share/fonts"
  fonts="inconsolata-lgc.tar.gz \
    roboto-mono.tar.gz \
    terminus-console.tar.gz \
    terminus-x11.tar.gz"
  cd $fontsdir
  for font in $fonts; do
    tar -xzf "$fontsdir/$font"
  done
}

setup_shell() {
  zsh=$(grep 'zsh$' /etc/shells 2>/dev/null|head -1)
  if [ -x "$zsh" ] && grep "^$LOGNAME:" /etc/passwd >/dev/null; then
    if ! grep "^$LOGNAME:.*zsh" /etc/passwd >/dev/null; then
      echo "Changing login shell."
      chsh -s "$zsh"
    fi
  fi
}

setup_grml_zsh(){
  curl -o "$HOME/.zshrc" https://git.grml.org/f/grml-etc-core/etc/zsh/zshrc
}

[ $# -gt 0 ] || set -- default

command="$1"
shift

case "$command" in
  default)
    setup_basics
    setup_fonts
    setup_shell
    ;;

  update-grml-zsh)
    setup_grml_zsh
    ;;

  console)
    setfont $HOME/.local/share/fonts/terminus-console/ter-c18n.psf.gz
    as_root loadkeys $HOME/.local/share/kbd/keymaps/ruwin_sh_sh_UTF-8.map
    ;;

  '') echo "Usage: `basename "$0"` <command> [options]" 
    ;;

  *) 
    echo "`basename "$0"` $command: unknown command." >&2; exit 1 
    ;;
esac
