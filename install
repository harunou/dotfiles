#!/bin/bash
# vim: set ft=sh:

set -e

if ! command -v git >/dev/null 2>&1; then
  echo "Error: Git is not installed."
  exit 1
fi

repo_dir=$(realpath "${1:-$HOME/.harunou}")
dots_dir=$(realpath "${2:-$HOME}")

if [ -d "$repo_dir" ]; then
  echo "Error: Directory \"$repo_dir\" already exists. Remove it or specify a different path."
  exit 1
fi

git clone https://github.com/harunou/harunou.git "$repo_dir" || {
  echo "Error: Failed to clone the repository."
  exit 1
}

cd "$repo_dir" || { 
  echo "Error: Failed to change directory to \"$repo_dir\"."
  exit 1
}

echo "Setting up the repository with dot files..."

if ! ./config setup-repo "$repo_dir" "$dots_dir"; then
  echo "Error: Repository setup failed."
  exit 1
fi

# Final instructions for the user
echo "\n============================================================"
echo "Dot files have been successfully installed in \"$dots_dir\"."
echo "To complete the setup, follow these steps:"
echo "1. To export the dot files, run: \`git export\` in the repository directory: \"$repo_dir\"."
echo "2. Logout and login back to apply the changes."
echo "3. Finally, run: \`harunou install default\` to finish the installation."
echo "============================================================"
